<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>apis_core.apis_entities.api_views &mdash; APIS 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=f2a433a1"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            APIS
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation with Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html#installation-without-docker">Installation without Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_documentation.html">User documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_model.html">Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Development</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Internals:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../py-modindex.html">Module Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">APIS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">apis_core.apis_entities.api_views</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for apis_core.apis_entities.api_views</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">TextIOWrapper</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">api_view</span>
<span class="kn">from</span> <span class="nn">rest_framework.generics</span> <span class="kn">import</span> <span class="n">GenericAPIView</span>
<span class="kn">from</span> <span class="nn">rest_framework.pagination</span> <span class="kn">import</span> <span class="n">PageNumberPagination</span>
<span class="kn">from</span> <span class="nn">rest_framework.parsers</span> <span class="kn">import</span> <span class="n">FileUploadParser</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.reverse</span> <span class="kn">import</span> <span class="n">reverse_lazy</span>
<span class="kn">from</span> <span class="nn">rest_framework.settings</span> <span class="kn">import</span> <span class="n">api_settings</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>

<span class="kn">from</span> <span class="nn">apis_core.apis_metainfo.models</span> <span class="kn">import</span> <span class="n">Uri</span><span class="p">,</span> <span class="n">RootObject</span>
<span class="kn">from</span> <span class="nn">.api_renderers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">EntityToTEI</span><span class="p">,</span>
    <span class="n">EntityToCIDOCXML</span><span class="p">,</span>
    <span class="n">EntityToProsopogrAPhI</span><span class="p">,</span>
    <span class="n">EntityToCIDOCN3</span><span class="p">,</span>
    <span class="n">EntityToCIDOCNQUADS</span><span class="p">,</span>
    <span class="n">EntityToCIDOCTURTLE</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.serializers_generic</span> <span class="kn">import</span> <span class="n">EntitySerializer</span>
<span class="kn">from</span> <span class="nn">apis_core.utils</span> <span class="kn">import</span> <span class="n">caching</span>
<span class="kn">from</span> <span class="nn">apis_core.utils.utils</span> <span class="kn">import</span> <span class="n">get_python_safe_module_path</span>


<div class="viewcode-block" id="StandardResultsSetPagination">
<a class="viewcode-back" href="../../../modules/apis_core.apis_entities.html#apis_core.apis_entities.api_views.StandardResultsSetPagination">[docs]</a>
<span class="k">class</span> <span class="nc">StandardResultsSetPagination</span><span class="p">(</span><span class="n">PageNumberPagination</span><span class="p">):</span>
    <span class="n">page_size</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="n">page_size_query_param</span> <span class="o">=</span> <span class="s2">&quot;page_size&quot;</span>
    <span class="n">max_page_size</span> <span class="o">=</span> <span class="mi">1000</span></div>



<div class="viewcode-block" id="GetEntityGeneric">
<a class="viewcode-back" href="../../../modules/apis_core.apis_entities.html#apis_core.apis_entities.api_views.GetEntityGeneric">[docs]</a>
<span class="k">class</span> <span class="nc">GetEntityGeneric</span><span class="p">(</span><span class="n">GenericAPIView</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">EntitySerializer</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">RootObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">renderer_classes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">api_settings</span><span class="o">.</span><span class="n">DEFAULT_RENDERER_CLASSES</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">EntityToTEI</span><span class="p">,</span>
        <span class="n">EntityToCIDOCXML</span><span class="p">,</span>
        <span class="n">EntityToProsopogrAPhI</span><span class="p">,</span>
        <span class="n">EntityToCIDOCN3</span><span class="p">,</span>
        <span class="n">EntityToCIDOCNQUADS</span><span class="p">,</span>
        <span class="n">EntityToCIDOCTURTLE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;APIS_RENDERERS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rend_add</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">APIS_RENDERERS</span><span class="p">:</span>
            <span class="n">rend_mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">rd</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">rend_mod</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">rend_add</span> <span class="o">+</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,)</span>
        <span class="n">renderer_classes</span> <span class="o">+=</span> <span class="n">rend_add</span>

<div class="viewcode-block" id="GetEntityGeneric.get_object">
<a class="viewcode-back" href="../../../modules/apis_core.apis_entities.html#apis_core.apis_entities.api_views.GetEntityGeneric.get_object">[docs]</a>
    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RootObject</span><span class="o">.</span><span class="n">objects_inheritance</span><span class="o">.</span><span class="n">get_subclass</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RootObject</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">uri2</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">uri2</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">RootObject</span><span class="o">.</span><span class="n">objects_inheritance</span><span class="o">.</span><span class="n">get_subclass</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">uri2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">entity_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Http404</span></div>


<div class="viewcode-block" id="GetEntityGeneric.get">
<a class="viewcode-back" href="../../../modules/apis_core.apis_entities.html#apis_core.apis_entities.api_views.GetEntityGeneric.get">[docs]</a>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="n">ent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="c1"># we let users override the default serializer based on the chosen renderer</span>
        <span class="c1"># the name of the method has to be the full path of the renderer, dots</span>
        <span class="c1"># replaced with underscores</span>
        <span class="c1"># i.e.: apis_core_apis_entities_api_renderers_EntityToTEI</span>
        <span class="n">renderer_full_path</span> <span class="o">=</span> <span class="n">get_python_safe_module_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">accepted_renderer</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">renderer_full_path</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">renderer_full_path</span><span class="p">)(</span><span class="n">ent</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">EntitySerializer</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>
</div>



<span class="c1"># TODO RDF: Check if this should be removed or adapted</span>
<span class="c1">#</span>
<span class="c1"># class InstitutionViewSet(viewsets.ModelViewSet):</span>
<span class="c1">#     &quot;&quot;&quot;Serialization of the institution class.</span>
<span class="c1">#     In addition to the institution this view includes related texts and \</span>
<span class="c1">#     the kind of the institution (separated object).&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     permission_classes = (DjangoObjectPermissions,)</span>
<span class="c1">#     queryset = Institution.objects.all()</span>
<span class="c1">#     serializer_class = InstitutionSerializer</span>
<span class="c1">#     filter_backends = (DjangoFilterBackend, filters.SearchFilter)</span>
<span class="c1">#     depth = 2</span>
<span class="c1">#     filter_fields = (&quot;name&quot;, &quot;kind__name&quot;, &quot;collection__name&quot;)</span>
<span class="c1">#     search_fields = (&quot;name&quot;,)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class PersonViewSet(viewsets.ModelViewSet):</span>
<span class="c1">#     &quot;&quot;&quot;Serialization of the Person class.</span>
<span class="c1">#     In addition to the person this view includes related texts (e.g. biographies), \</span>
<span class="c1">#     a list of professions (separated objects) and the collection it belongs to.&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     permission_classes = (DjangoObjectPermissions,)</span>
<span class="c1">#     queryset = Person.objects.all()</span>
<span class="c1">#     serializer_class = PersonSerializer</span>
<span class="c1">#     depth = 2</span>
<span class="c1">#     filter_backends = (DjangoFilterBackend, filters.SearchFilter)</span>
<span class="c1">#     filter_fields = (</span>
<span class="c1">#         &quot;name&quot;,</span>
<span class="c1">#         &quot;first_name&quot;,</span>
<span class="c1">#         &quot;gender&quot;,</span>
<span class="c1">#         &quot;profession__name&quot;,</span>
<span class="c1">#         &quot;collection__name&quot;,</span>
<span class="c1">#         &quot;uri__uri&quot;,</span>
<span class="c1">#     )</span>
<span class="c1">#     search_fields = (&quot;name&quot;, &quot;first_name&quot;)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class PlaceViewSet(viewsets.ModelViewSet):</span>
<span class="c1">#     &quot;&quot;&quot;Serialization of the Place class.</span>
<span class="c1">#     In addition to the place this view includes related texts (e.g. from the ÖBL database), \</span>
<span class="c1">#      and the collection it belongs to.&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     permission_classes = (DjangoObjectPermissions,)</span>
<span class="c1">#     queryset = Place.objects.all()</span>
<span class="c1">#     serializer_class = PlaceSerializer</span>
<span class="c1">#     filter_backends = (DjangoFilterBackend, filters.SearchFilter)</span>
<span class="c1">#     depth = 2</span>
<span class="c1">#     filter_fields = (&quot;name&quot;, &quot;kind__name&quot;, &quot;collection__name&quot;)</span>
<span class="c1">#     search_fields = (&quot;name&quot;,)</span>
<span class="c1">#     renderer_classes = tuple(api_settings.DEFAULT_RENDERER_CLASSES) + (</span>
<span class="c1">#         PaginatedCSVRenderer,</span>
<span class="c1">#     )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class EventViewSet(viewsets.ModelViewSet):</span>
<span class="c1">#     &quot;&quot;&quot;Serialization of the event class.</span>
<span class="c1">#     In addition to the event this view includes related texts and</span>
<span class="c1">#     the kind of the event (separated object).&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     permission_classes = (DjangoObjectPermissions,)</span>
<span class="c1">#     queryset = Event.objects.all()</span>
<span class="c1">#     serializer_class = EventSerializer</span>
<span class="c1">#     filter_backends = (DjangoFilterBackend, filters.SearchFilter)</span>
<span class="c1">#     depth = 2</span>
<span class="c1">#     filter_fields = (&quot;name&quot;, &quot;kind__name&quot;, &quot;collection__name&quot;)</span>
<span class="c1">#     search_fields = (&quot;name&quot;,)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class WorkViewSet(viewsets.ModelViewSet):</span>
<span class="c1">#     &quot;&quot;&quot;Serialization of the work class.</span>
<span class="c1">#     In addition to the work this view includes related texts and</span>
<span class="c1">#     the kind of the work (separated object).&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     permission_classes = (DjangoObjectPermissions,)</span>
<span class="c1">#     queryset = Work.objects.all()</span>
<span class="c1">#     serializer_class = WorkSerializer</span>
<span class="c1">#     filter_backends = (DjangoFilterBackend, filters.SearchFilter)</span>
<span class="c1">#     depth = 2</span>
<span class="c1">#     filter_fields = (&quot;name&quot;, &quot;kind__name&quot;, &quot;collection__name&quot;)</span>
<span class="c1">#     search_fields = (&quot;name&quot;,)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class PlaceGeoJsonViewSet(viewsets.ViewSet):</span>
<span class="c1">#     def list(self, request):</span>
<span class="c1">#         queryset = request.query_params.get(&quot;q&quot;, None)</span>
<span class="c1">#         diff = re.match(r&quot;^([^\[]*)\[(\d+)\]&quot;, queryset)</span>
<span class="c1">#         match_url = re.search(r&quot;geonames[^0-9]+([0-9]+)&quot;, queryset)</span>
<span class="c1">#         res = False</span>
<span class="c1">#         if match_url:</span>
<span class="c1">#             for u in autocomp_settings[&quot;Place&quot;]:</span>
<span class="c1">#                 if &quot;url&quot; in u.keys():</span>
<span class="c1">#                     site = re.search(&quot;site/([^/]+)/&quot;, u[&quot;url&quot;])</span>
<span class="c1">#                     if site:</span>
<span class="c1">#                         params = {</span>
<span class="c1">#                             &quot;id&quot;: &quot;http://sws.geonames.org/{}/&quot;.format(</span>
<span class="c1">#                                 match_url.group(1)</span>
<span class="c1">#                             )</span>
<span class="c1">#                         }</span>
<span class="c1">#                         headers = {&quot;Content-Type&quot;: &quot;application/json&quot;}</span>
<span class="c1">#                         w = requests.get(</span>
<span class="c1">#                             stb_base + site.group(1) + &quot;/entity&quot;,</span>
<span class="c1">#                             params=params,</span>
<span class="c1">#                             headers=headers,</span>
<span class="c1">#                         )</span>
<span class="c1">#                         if w.status_code == 200:</span>
<span class="c1">#                             if &quot;representation&quot; in w.json().keys():</span>
<span class="c1">#                                 res = [True, w.json()[&quot;representation&quot;]]</span>
<span class="c1">#                                 break</span>
<span class="c1">#         elif diff and queryset:</span>
<span class="c1">#             queryset = diff.group(1)</span>
<span class="c1">#             res = find_loc(queryset.split(&quot;,&quot;), dec_diff=int(diff.group(2)))</span>
<span class="c1">#         elif queryset:</span>
<span class="c1">#             res = find_loc(queryset.split(&quot;,&quot;))</span>
<span class="c1">#         else:</span>
<span class="c1">#             res = False, False</span>
<span class="c1">#         if res[1]:</span>
<span class="c1">#             if type(res[1]) is not list:</span>
<span class="c1">#                 res = (res[0], [res[1]])</span>
<span class="c1">#             serializer = GeoJsonSerializer(</span>
<span class="c1">#                 res[1],</span>
<span class="c1">#                 many=True,</span>
<span class="c1">#                 context={&quot;p_pk&quot;: request.query_params.get(&quot;p_pk&quot;, None)},</span>
<span class="c1">#             )</span>
<span class="c1">#         else:</span>
<span class="c1">#             serializer = GeoJsonSerializer(</span>
<span class="c1">#                 [], many=True, context={&quot;p_pk&quot;: request.query_params.get(&quot;p_pk&quot;, None)}</span>
<span class="c1">#             )</span>
<span class="c1">#         return Response(serializer.data)</span>


<span class="c1"># class NetJsonViewSet(viewsets.GenericViewSet):</span>
<span class="c1">#</span>
<span class="c1">#     def get_queryset(self):</span>
<span class="c1">#         rel = self.request.data[&quot;select_relation&quot;]</span>
<span class="c1">#         # q = AbstractRelation.get_relation_class_of_name(&quot;&quot;.join(rel.split(&quot;-&quot;)))</span>
<span class="c1">#         q = None</span>
<span class="c1">#         return q.objects.all()</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#     def create(self, request):</span>
<span class="c1">#         rel = request.data[&quot;select_relation&quot;]</span>
<span class="c1">#         if &quot;select_kind&quot; in request.data.keys():</span>
<span class="c1">#             kind = request.data[&quot;select_kind&quot;]</span>
<span class="c1">#         else:</span>
<span class="c1">#             kind = None</span>
<span class="c1">#         if &quot;annotation_proj&quot; in request.data.keys():</span>
<span class="c1">#             annotation_proj = request.data[&quot;annotation_proj&quot;]</span>
<span class="c1">#         else:</span>
<span class="c1">#             annotation_proj = None</span>
<span class="c1">#         if &quot;ann_include_all&quot; in request.data.keys():</span>
<span class="c1">#             ann_include_all = True</span>
<span class="c1">#         else:</span>
<span class="c1">#             ann_include_all = False</span>
<span class="c1">#         # q = AbstractRelation.get_relation_class_of_name(&quot;&quot;.join(rel.split(&quot;-&quot;)))</span>
<span class="c1">#         q = None</span>
<span class="c1">#         rel_match = re.match(r&quot;([A-Z][a-z]+)([A-Z][a-z]+$)&quot;, rel)</span>
<span class="c1">#         lst_nodes = []</span>
<span class="c1">#         rel_a = &quot;related_&quot; + rel.split(&quot;-&quot;)[0]</span>
<span class="c1">#         rel_b = &quot;related_&quot; + rel.split(&quot;-&quot;)[1]</span>
<span class="c1">#         q_dict = {}</span>
<span class="c1">#         q_list = None</span>
<span class="c1">#         if rel_a == rel_b:</span>
<span class="c1">#             rel_a += &quot;A&quot;</span>
<span class="c1">#             rel_b += &quot;B&quot;</span>
<span class="c1">#         if &quot;search_source&quot; in request.data.keys():</span>
<span class="c1">#             source = request.data[&quot;search_source&quot;]</span>
<span class="c1">#             if source.startswith(&quot;cl:&quot;):</span>
<span class="c1">#                 if q_list is not None:</span>
<span class="c1">#                     q_list.append(</span>
<span class="c1">#                         Q(**{rel_a + &quot;__collection__id&quot;: int(source[3:])})</span>
<span class="c1">#                         | Q(**{rel_b + &quot;__collection__id&quot;: int(source[3:])})</span>
<span class="c1">#                     )</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     q_dict[rel_a + &quot;__collection__id&quot;] = int(source[3:])</span>
<span class="c1">#             else:</span>
<span class="c1">#                 if q_list is not None:</span>
<span class="c1">#                     q_list.append(</span>
<span class="c1">#                         Q(**{rel_a + &quot;_id&quot;: int(source)})</span>
<span class="c1">#                         | Q(**{rel_b + &quot;_id&quot;: int(source)})</span>
<span class="c1">#                     )</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     q_dict[rel_a + &quot;_id&quot;] = int(source)</span>
<span class="c1">#         elif &quot;search_source-autocomplete&quot; in request.data.keys():</span>
<span class="c1">#             source = request.data[&quot;search_source-autocomplete&quot;]</span>
<span class="c1">#             if q_list is not None:</span>
<span class="c1">#                 q_list.append(</span>
<span class="c1">#                     Q(**{rel_a + &quot;__name__icontains&quot;: source})</span>
<span class="c1">#                     | Q(**{rel_b + &quot;__name__icontains&quot;: source})</span>
<span class="c1">#                 )</span>
<span class="c1">#             else:</span>
<span class="c1">#                 q_dict[rel_a + &quot;__name__icontains&quot;] = source</span>
<span class="c1">#         if &quot;search_target&quot; in request.data.keys():</span>
<span class="c1">#             target = request.data[&quot;search_target&quot;]</span>
<span class="c1">#             if target.startswith(&quot;cl:&quot;):</span>
<span class="c1">#                 if q_list is not None:</span>
<span class="c1">#                     q_list.append(</span>
<span class="c1">#                         Q(**{rel_b + &quot;__collection__id&quot;: int(target[3:])})</span>
<span class="c1">#                         | Q(**{rel_a + &quot;__collection__id&quot;: int(target[3:])})</span>
<span class="c1">#                     )</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     q_dict[rel_b + &quot;__collection__id&quot;] = int(target[3:])</span>
<span class="c1">#             else:</span>
<span class="c1">#                 if q_list is not None:</span>
<span class="c1">#                     q_list.append(</span>
<span class="c1">#                         Q(**{rel_a + &quot;_id&quot;: int(target)})</span>
<span class="c1">#                         | Q(**{rel_b + &quot;_id&quot;: int(target)})</span>
<span class="c1">#                     )</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     q_dict[rel_b + &quot;_id&quot;] = target</span>
<span class="c1">#         elif &quot;search_target-autocomplete&quot; in request.data.keys():</span>
<span class="c1">#             if len(request.data[&quot;search_target-autocomplete&quot;]) &gt; 0:</span>
<span class="c1">#                 target = request.data[&quot;search_target-autocomplete&quot;]</span>
<span class="c1">#                 if q_list is not None:</span>
<span class="c1">#                     q_list.append(</span>
<span class="c1">#                         Q(**{rel_a + &quot;__name__icontains&quot;: target})</span>
<span class="c1">#                         | Q(**{rel_b + &quot;__name__icontains&quot;: target})</span>
<span class="c1">#                     )</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     q_dict[rel_b + &quot;__name__icontains&quot;] = target</span>
<span class="c1">#         if kind:</span>
<span class="c1">#             kind_ids = [int(kind.strip())]</span>
<span class="c1">#             kind_ids_res = [int(kind.strip())]</span>
<span class="c1">#             while len(kind_ids) &gt; 0:</span>
<span class="c1">#                 id_a = kind_ids.pop()</span>
<span class="c1">#                 ids_b = VocabsBaseClass.objects.filter(</span>
<span class="c1">#                     parent_class_id=id_a</span>
<span class="c1">#                 ).values_list(&quot;pk&quot;, flat=True)</span>
<span class="c1">#                 kind_ids.extend(ids_b)</span>
<span class="c1">#                 kind_ids_res.extend(ids_b)</span>
<span class="c1">#             q_dict[&quot;relation_type_id__in&quot;] = kind_ids_res</span>
<span class="c1">#         if &quot;start_date&quot; in request.data.keys():</span>
<span class="c1">#             if len(request.data[&quot;start_date&quot;]) &gt; 0:</span>
<span class="c1">#                 start_date_d = datetime.strptime(request.data[&quot;start_date&quot;], &quot;%d.%m.%Y&quot;)</span>
<span class="c1">#                 q_dict[&quot;end_date__gte&quot;] = start_date_d</span>
<span class="c1">#         if &quot;end_date&quot; in request.data.keys():</span>
<span class="c1">#             if len(request.data[&quot;end_date&quot;]) &gt; 0:</span>
<span class="c1">#                 end_date_d = datetime.strptime(request.data[&quot;end_date&quot;], &quot;%d.%m.%Y&quot;)</span>
<span class="c1">#                 q_dict[&quot;start_date__lte&quot;] = end_date_d</span>
<span class="c1">#         if annotation_proj:</span>
<span class="c1">#             annProj_filter = {&quot;ann_proj&quot;: annotation_proj}</span>
<span class="c1">#             if not ann_include_all:</span>
<span class="c1">#                 annProj_filter[&quot;include_all&quot;] = False</span>
<span class="c1">#             sr1 = (</span>
<span class="c1">#                 q.annotation_links.filter_ann_proj(**annProj_filter)</span>
<span class="c1">#                 .filter(**q_dict)</span>
<span class="c1">#                 .select_related(rel_a, rel_b)</span>
<span class="c1">#             )</span>
<span class="c1">#         else:</span>
<span class="c1">#             sr1 = q.objects.filter(**q_dict)</span>
<span class="c1">#         if q_list is not None:</span>
<span class="c1">#             sr1 = sr1.filter(q_list[0])</span>
<span class="c1">#         for node in sr1:</span>
<span class="c1">#             if getattr(node, rel_a) not in lst_nodes:</span>
<span class="c1">#                 lst_nodes.append(getattr(node, rel_a))</span>
<span class="c1">#             if getattr(node, rel_b) not in lst_nodes:</span>
<span class="c1">#                 lst_nodes.append(getattr(node, rel_b))</span>
<span class="c1">#         sr1_1 = NetJsonEdgeSerializer(sr1, many=True)</span>
<span class="c1">#         sr1_2 = NetJsonNodeSerializer(lst_nodes, many=True)</span>
<span class="c1">#         res = {&quot;nodes&quot;: sr1_2.data, &quot;edges&quot;: sr1_1.data}</span>
<span class="c1">#         return Response(res)</span>
<span class="c1">#</span>
<span class="c1"># __after_rdf_refactoring__</span>


<div class="viewcode-block" id="ResolveAbbreviations">
<a class="viewcode-back" href="../../../modules/apis_core.apis_entities.html#apis_core.apis_entities.api_views.ResolveAbbreviations">[docs]</a>
<span class="k">class</span> <span class="nc">ResolveAbbreviations</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">parser_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">FileUploadParser</span><span class="p">,)</span>

<div class="viewcode-block" id="ResolveAbbreviations.put">
<a class="viewcode-back" href="../../../modules/apis_core.apis_entities.html#apis_core.apis_entities.api_views.ResolveAbbreviations.put">[docs]</a>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">file_obj</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">204</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="GetOrCreateEntity">
<a class="viewcode-back" href="../../../modules/apis_core.apis_entities.html#apis_core.apis_entities.api_views.GetOrCreateEntity">[docs]</a>
<span class="k">class</span> <span class="nc">GetOrCreateEntity</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<div class="viewcode-block" id="GetOrCreateEntity.get">
<a class="viewcode-back" href="../../../modules/apis_core.apis_entities.html#apis_core.apis_entities.api_views.GetOrCreateEntity.get">[docs]</a>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entity2&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uri&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uri</span> <span class="ow">and</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;http:&quot;</span><span class="p">,</span> <span class="s2">&quot;https:&quot;</span><span class="p">)):</span>
            <span class="n">u</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">)</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">root_object</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[^&lt;]+&quot;</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;([^&gt;]+)&gt;&quot;</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
            <span class="n">q_d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">q_d</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r1</span>
            <span class="k">if</span> <span class="n">r2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">):</span>
                    <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                    <span class="n">q_d</span><span class="p">[</span><span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">x2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">entity</span> <span class="o">==</span> <span class="s2">&quot;person&quot;</span><span class="p">:</span>
                <span class="n">r1_2</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r1_2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">q_d</span><span class="p">[</span><span class="s2">&quot;first_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r1_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">q_d</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r1_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">caching</span><span class="o">.</span><span class="n">get_ontology_class_of_name</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">q_d</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">ent</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">reverse_lazy</span><span class="p">(</span>
                <span class="s2">&quot;apis:apis_entities:generic_entities_edit_view&quot;</span><span class="p">,</span>
                <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="n">ent</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="s2">&quot;entity&quot;</span><span class="p">:</span> <span class="n">entity</span><span class="p">},</span>
            <span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>
</div>



<span class="c1"># TODO RDF: Check if this should be removed or adapted</span>
<span class="c1">#</span>
<span class="c1"># class GetRelatedPlaces(APIView):</span>
<span class="c1">#     #map_qs = {</span>
<span class="c1">#      #   &#39;institution&#39;: Prefetch(&#39;personinstitution_set__related_institution__institutionplace_set&#39;, queryset=InstitutionPlace.objects.select_related(&#39;related_place&#39;))</span>
<span class="c1">#     #}</span>
<span class="c1">#</span>
<span class="c1">#     def get(self, request):</span>
<span class="c1">#         b_rel = PersonPlaceRelation.objects.get(name=getattr(settings, &#39;BIRTH_REL_NAME&#39;, &#39;&#39;))</span>
<span class="c1">#         d_rel = PersonPlaceRelation.objects.get(name=getattr(settings, &#39;DEATH_REL_NAME&#39;, &#39;&#39;))</span>
<span class="c1">#         person_pk = request.query_params.get(&quot;person_id&quot;, None)</span>
<span class="c1">#         pers = Person.objects.get(pk=person_pk)</span>
<span class="c1">#         relation_types = request.query_params.get(&quot;relation_types&quot;, None)</span>
<span class="c1">#         place_pk = dict()</span>
<span class="c1">#         res = []</span>
<span class="c1">#         p = PersonPlace.objects.select_related(&#39;related_place&#39;).filter(related_person_id=person_pk, related_place__lat__isnull=False).filter_for_user()</span>
<span class="c1">#         for pp in p:</span>
<span class="c1">#             if pp.related_place_id not in place_pk:</span>
<span class="c1">#                 res.append((pp.related_place, [(</span>
<span class="c1">#                     pp.relation_type, None,</span>
<span class="c1">#                     pers.start_date if b_rel.pk == pp.relation_type_id else pp.start_date,</span>
<span class="c1">#                     pers.end_date if d_rel.pk == pp.relation_type_id else pp.end_date, pp)]))</span>
<span class="c1">#                 place_pk[pp.related_place_id] = len(res)-1</span>
<span class="c1">#             else:</span>
<span class="c1">#                 res[place_pk[pp.related_place_id]][1].append((</span>
<span class="c1">#                     pp.relation_type, None,</span>
<span class="c1">#                     pers.start_date if b_rel.pk == pp.relation_type_id else pp.start_date,</span>
<span class="c1">#                     pers.end_date if d_rel.pk == pp.relation_type_id else pp.end_date, pp))</span>
<span class="c1">#         for pi in PersonInstitution.objects.filter(related_person_id=person_pk).filter_for_user():</span>
<span class="c1">#             inst = pi.related_institution</span>
<span class="c1">#             rel_type = getattr(settings, &#39;APIS_LOCATED_IN_ATTR&#39;, [&#39;situated in&#39;,])</span>
<span class="c1">#             ipl_rel = InstitutionPlaceRelation.objects.filter(name__in=rel_type).values_list(&#39;pk&#39;, flat=True)</span>
<span class="c1">#             plc = InstitutionPlace.objects.filter(relation_type_id__in=ipl_rel, related_institution=inst)</span>
<span class="c1">#             if plc.count() == 1:</span>
<span class="c1">#                 if plc[0].related_place_id not in place_pk:</span>
<span class="c1">#                     res.append((plc[0].related_place, [(pi.relation_type, pi.related_institution, pi.start_date, pi.end_date, pi)]))</span>
<span class="c1">#                     place_pk[plc[0].related_place_id] = len(res)-1</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     res[place_pk[plc[0].related_place_id]][1].append((pi.relation_type, pi.related_institution, pi.start_date, pi.end_date, pi))</span>
<span class="c1">#         res = GeoJsonSerializerTheme(res, many=True)</span>
<span class="c1">#         return Response(res.data)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class LifePathViewset(APIView):</span>
<span class="c1">#</span>
<span class="c1">#     def get(self, request, pk):</span>
<span class="c1">#         b_rel = PersonPlaceRelation.objects.get(name=getattr(settings, &#39;BIRTH_REL_NAME&#39;, &#39;&#39;))</span>
<span class="c1">#         d_rel = PersonPlaceRelation.objects.get(name=getattr(settings, &#39;DEATH_REL_NAME&#39;, &#39;&#39;))</span>
<span class="c1">#         pb_pd = [b_rel.pk, d_rel.pk]</span>
<span class="c1">#         lst_inst = list(PersonInstitution.objects.filter(Q(related_person_id=pk), Q(start_date__isnull=False)|Q(end_date__isnull=False)).filter_for_user())</span>
<span class="c1">#         lst_place = list(PersonPlace.objects.filter(Q(related_person_id=pk), Q(start_date__isnull=False)|Q(end_date__isnull=False)|Q(relation_type_id__in=pb_pd)).filter_for_user())</span>
<span class="c1">#         comb_lst = lst_inst + lst_place</span>
<span class="c1">#         p1 = Person.objects.get(pk=pk)</span>
<span class="c1">#         if p1.start_date:</span>
<span class="c1">#             for e in comb_lst:</span>
<span class="c1">#                 if e.relation_type_id == b_rel.pk:</span>
<span class="c1">#                     e.start_date = p1.start_date</span>
<span class="c1">#         if p1.end_date:</span>
<span class="c1">#             for e in comb_lst:</span>
<span class="c1">#                 if e.relation_type_id == d_rel.pk:</span>
<span class="c1">#                     e.start_date = p1.end_date</span>
<span class="c1">#         data = LifePathSerializer(comb_lst, many=True).data</span>
<span class="c1">#         data = [d for d in data if d is not None]</span>
<span class="c1">#         data = sorted(data, key = lambda i: i[&#39;year&#39;])</span>
<span class="c1">#</span>
<span class="c1">#         return Response(data)</span>
<span class="c1">#</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Matthias Schlögl.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>